<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>–°–æ—Ç—Ä—É–¥–Ω–∏–∫ –°–ö –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å.</title>
  <link rel="stylesheet" href="style.css">
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700;900&family=Playfair+Display:wght@400;700&display=swap" rel="stylesheet">
  <style>
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.7; }
    }

    .subobject-group {
      margin: 12px 0;
      padding: 12px;
      background: #f8fafc;
      border-radius: 6px;
      border: 1px solid #e2e8f0;
    }

    .risk-groups {
      margin-top: 8px;
      margin-left: 12px;
      display: flex;
      gap: 16px;
    }

    .calc-button {
      background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 6px;
      font-size: 16px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .calc-button:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.15);
    }

    .variant-info {
      color: #059669;
      font-weight: 500;
      margin-bottom: 8px;
    }

    .special-offer {
      background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%);
      border: 1px solid #10b981;
      border-radius: 6px;
      padding: 12px;
      margin-top: 8px;
    }

    .special-offer-title {
      color: #059669;
      font-weight: 600;
      margin-bottom: 4px;
    }

    /* –°—Ç–∏–ª–∏ –¥–ª—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ —Ä–∞—Å—á–µ—Ç–æ–≤ */
    .results .product {
      border: 1px solid #e2e8f0;
      border-radius: 8px;
      padding: 16px;
      margin-bottom: 16px;
      background: #fafbfc;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }

    .results .product b {
      color: #1e40af;
      font-size: 18px;
      margin-bottom: 12px;
      display: block;
    }

    .results .product .total {
      font-weight: bold;
      font-size: 16px;
      color: #059669;
      margin-top: 12px;
      padding-top: 8px;
      border-top: 2px solid #10b981;
    }

    .results .product div {
      margin: 4px 0;
      line-height: 1.4;
    }

    .results .product .variant-info {
      color: #059669;
      font-weight: 500;
      margin-bottom: 8px;
    }

    .results .product .special-offer {
      background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%);
      border: 1px solid #10b981;
      border-radius: 6px;
      padding: 12px;
      margin-top: 8px;
    }

    .results .product .special-offer-title {
      color: #059669;
      font-weight: 600;
      margin-bottom: 4px;
    }
  </style>
</head>
<body>
  <!-- –ì–µ—Ä–æ–π—Å–∫–∞—è —Å–µ–∫—Ü–∏—è -->
  <header class="hero-section">
    <div class="hero-overlay"></div>
    <div class="hero-content">
      <div class="hero-logo">
        <div class="logo-icon">üèõÔ∏è</div>
        <h1 class="hero-title">–ò–ù–ì–û–°–°–¢–†–ê–•</h1>
        <div class="hero-subtitle">–°—Ä–∞–≤–Ω–µ–Ω–∏–µ –ø—Ä–æ–¥—É–∫—Ç–æ–≤ –ò–§–õ</div>
      </div>
    </div>
    <div class="hero-decoration">
      <div class="decoration-element"></div>
      <div class="decoration-element"></div>
      <div class="decoration-element"></div>
    </div>
  </header>

  <!-- –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç -->
  <main class="main-content">
    <div class="container">
      <a href="index.html" class="back-button">
        <span>‚Üê</span> <span>–ù–∞–∑–∞–¥ –∫ –≤—ã–±–æ—Ä—É –ø—Ä–æ–¥—É–∫—Ç–æ–≤</span>
      </a>
      <div class="header"><h1 style="margin:0">–ú—É–ª—å—Ç–∏–≤–∞—Ä–∏–∞—Ç–∏–≤–Ω—ã–π –ø—Ä–æ–¥—É–∫—Ç –°–ö</h1></div>
  <div class="card">
    <strong>–≤—ã–±–µ—Ä–∏ –∏ –ø–æ–ª—É—á–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç</strong>
  </div>

  <div class="card">
    <h3>–ß—Ç–æ —Å—Ç—Ä–∞—Ö—É–µ–º?</h3>
    <label><input type="radio" name="type" value="house" checked> –ñ–∏–ª–æ–π –¥–æ–º</label>
    <label><input type="radio" name="type" value="flat"> –ö–≤–∞—Ä—Ç–∏—Ä–∞</label>
    <div id="materialBlock" class="small" style="margin-top:8px">
      –ú–∞—Ç–µ—Ä–∏–∞–ª —Å—Ç–µ–Ω: 
      <label><input type="radio" name="material" value="stone" checked> –ö–∞–º–µ–Ω—å / –∫–∏—Ä–ø–∏—á</label>
      <label><input type="radio" name="material" value="wood"> –î–µ—Ä–µ–≤–æ</label>
    </div>
  </div>

  <div class="card">
    <h3>–í–≤–æ–¥ —Å—É–º–º –ø–æ –ø–æ–¥–æ–±—ä–µ–∫—Ç–∞–º</h3>
    <label>–ö–æ–Ω—Å—Ç—Ä—É–∫—Ç–∏–≤–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã: <input id="sum_cons" type="number" value="0"></label>

    <div class="subobject-group">
      <label>–û—Ç–¥–µ–ª–∫–∞ –∏ –∏–Ω–∂–µ–Ω–µ—Ä–Ω–æ–µ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ: <input id="sum_finish" type="number" value="0"></label>
      <div class="risk-groups">
        <label><input id="risk_finish_gr1" type="checkbox"> –ì—Ä—É–ø–ø–∞ —Ä–∏—Å–∫–æ–≤ 1</label>
        <label><input id="risk_finish_gr23" type="checkbox"> –ì—Ä—É–ø–ø–∞ —Ä–∏—Å–∫–æ–≤ 2+3</label>
      </div>
    </div>

    <div class="subobject-group">
      <label>–î–≤–∏–∂–∏–º–æ–µ –∏–º—É—â–µ—Å—Ç–≤–æ: <input id="sum_movable" type="number" value="0"></label>
      <div class="risk-groups">
        <label><input id="risk_movable_gr1" type="checkbox"> –ì—Ä—É–ø–ø–∞ —Ä–∏—Å–∫–æ–≤ 1</label>
        <label><input id="risk_movable_gr23" type="checkbox"> –ì—Ä—É–ø–ø–∞ —Ä–∏—Å–∫–æ–≤ 2+3</label>
      </div>
    </div>

    <label>–ì—Ä–∞–∂–¥–∞–Ω—Å–∫–∞—è –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å: <input id="sum_go" type="number" value="0"></label>

    <div style="margin-top:8px">
      <label><input id="insure_drone" type="checkbox"> –ó–∞—Å—Ç—Ä–∞—Ö–æ–≤–∞—Ç—å –æ—Ç –ë–ü–õ–ê (–ë–∞—Å—Ç–∏–æ–Ω)</label>
    </div>

    <div style="margin-top:12px">
      <button id="btnCalc" class="calc-button">–†–∞—Å—Å—á–∏—Ç–∞—Ç—å</button>
    </div>
  </div>

  <div class="card results">
    <h3>–†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ä–∞—Å—á–µ—Ç–æ–≤</h3>
    <div id="results"></div>
  </div>
    </div>
  </main>

  <script type="module">
/*
  Robust loader for tariff modules. Attempts dynamic import; if named export missing,
  fetches file and extracts const literal for the requested name.
*/
async function loadNamed(path, name) {
  try {
    const m = await import(path);
    if (m && (m[name] !== undefined)) return m[name];
    // try default
    if (m && m.default !== undefined) return m.default;
  } catch(e){
    // console.warn('import failed', path, e);
  }
  // fallback: fetch file and extract const <name> = <literal>;
  const txt = await (await fetch(path)).text();
  // try export const NAME = ... first
  const re2 = new RegExp(`export\\s+const\\s+${name}\\s*=\\s*([\\s\\S]*?);\\n`);
  let m = txt.match(re2);
  if (!m) {
    // try const NAME = ...
    const re = new RegExp(`const\\s+${name}\\s*=\\s*([\\s\\S]*?);\\n`);
    m = txt.match(re);
  }
  if (!m) {
    console.warn('Could not extract', name, 'from', path);
    return undefined;
  }
  const literal = m[1];
  try {
    return eval('(' + literal + ')');
  } catch(e){
    console.error('Eval failed for', name, e);
    return undefined;
  }
}

// load all tariffs we may need
let T_DOMBEZ, T_MOYA, EXPRESS_PACKS, PRODUCT5_TARIFFS, T_BASTION, EXPRESS_GO_PACKS;

// helper function for formatting numbers
const fmt = n => new Intl.NumberFormat('ru-RU').format(Math.round(n));

async function loadAll() {
  T_DOMBEZ = await loadNamed('./tariffs.dombez.js','TARIFFS');
  T_MOYA = await loadNamed('./tariffs.moyakvartira.js','T_MOYA');
  EXPRESS_PACKS = await loadNamed('./tariffs.express.js','EXPRESS_PACKS');
  PRODUCT5_TARIFFS = await loadNamed('./tariffs.platinum.express.js','PRODUCT5_TARIFFS');
  T_BASTION = await loadNamed('./tariffs.bastion.js','T_BASTION');
  EXPRESS_GO_PACKS = await loadNamed('./tariffs.express_go.js','EXPRESS_GO_PACKS');
  console.log('Tariffs loaded:', {T_DOMBEZ,T_MOYA,EXPRESS_PACKS,PRODUCT5_TARIFFS,T_BASTION,EXPRESS_GO_PACKS});
}
await loadAll();

// helper find rate in ranges
function findRateFromRanges(ranges, sum){
  if(!ranges) return 0;
  for(const r of ranges){
    if(sum >= (r.min||r.minSum||0) && sum <= (r.max||r.maxSum||Infinity)) return r.rate;
  }
  // fallback last
  if(ranges.length) return ranges[ranges.length-1].rate;
  return 0;
}

// calculate functions for products
function calcDomBez(sums, material){
  // T_DOMBEZ structure expected as in tariffs.dombez.js -> TARIFFS
  if(!T_DOMBEZ) return null;
  let res = {};
  // finish uses material
  const finishRates = T_DOMBEZ.finish && T_DOMBEZ.finish[material];
  let finishRate = findRateFromRanges(finishRates, sums.finish);
  if(sums.finish>0 && document.getElementById('risk_finish_gr1').checked) finishRate += (T_MOYA?.risks?.gr1 || 0.002);
  if(sums.finish>0 && document.getElementById('risk_finish_gr23').checked) finishRate += (T_MOYA?.risks?.gr23 || 0.0015);
  if(document.getElementById('hasStove') && finishRate) finishRate *= (T_DOMBEZ.stoveCoefficient || 1.15);
  const finishPrem = sums.finish * finishRate;
  // movable
  const movableRate = findRateFromRanges(T_DOMBEZ.movable || [], sums.movable);
  const movablePrem = sums.movable * movableRate;
  // liability
  const liRate = findRateFromRanges(T_DOMBEZ.liability || [], sums.liability);
  const liPrem = sums.liability * liRate;
  // constructive - not in dombez tariffs in our file; assume 0
  const consPrem = (T_DOMBEZ.constructive && findRateFromRanges(T_DOMBEZ.constructive[material]||[], sums.construct)) || 0;
  res.parts = [
    {name:'–û—Ç–¥–µ–ª–∫–∞ –∏ –ò–û', sum:sums.finish, rate:finishRate, prem:finishPrem},
    {name:'–î–≤–∏–∂–∏–º–æ–µ –∏–º—É—â–µ—Å—Ç–≤–æ', sum:sums.movable, rate:movableRate, prem:movablePrem},
    {name:'–ì—Ä–∞–∂–¥–∞–Ω—Å–∫–∞—è –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å', sum:sums.liability, rate:liRate, prem:liPrem},
    {name:'–ö–æ–Ω—Å—Ç—Ä—É–∫—Ç–∏–≤–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã', sum:sums.construct, rate:0, prem:consPrem}
  ];
  res.total = res.parts.reduce((a,b)=>a + (b.prem||0),0);
  return res;
}

function calcMoya(sums){
  if(!T_MOYA) return null;
  let res = {parts:[], total:0};
  // constructive
  if(sums.construct>0){
    const rate = (sums.construct>0 && ( (sums.finish>0||sums.movable>0) ? T_MOYA.constructive.withOthers : T_MOYA.constructive.only ));
    const prem = sums.construct * rate;
    res.parts.push({name:'–ö–æ–Ω—Å—Ç—Ä—É–∫—Ç–∏–≤', sum:sums.construct, rate, prem});
    res.total += prem;
  }
  // finish
  if(sums.finish>0){
    const rate = findRateFromRanges(T_MOYA.finish, sums.finish);
    const prem = sums.finish * rate;
    res.parts.push({name:'–û—Ç–¥–µ–ª–∫–∞ –∏ –ò–û', sum:sums.finish, rate, prem});
    res.total += prem;
  }
  // movable
  if(sums.movable>0){
    const rate = findRateFromRanges(T_MOYA.movable, sums.movable);
    const prem = sums.movable * rate;
    res.parts.push({name:'–î–≤–∏–∂–∏–º–æ–µ –∏–º—É—â–µ—Å—Ç–≤–æ', sum:sums.movable, rate, prem});
    res.total += prem;
  }
  // go
  if(sums.liability>0){
    const rate = (T_MOYA.go.alone || 0.007);
    const prem = sums.liability * rate;
    res.parts.push({name:'–ì–û', sum:sums.liability, rate, prem});
    res.total += prem;
  }
  // risks groups applied
  if(document.getElementById('risk_finish_gr1').checked){
    const extra = sums.finish * (T_MOYA.risks.gr1 || 0.002);
    res.parts.push({name:'–ì—Ä.1 (–û—Ç–¥–µ–ª–∫–∞)', sum:sums.finish, rate:(T_MOYA.risks.gr1||0.002), prem:extra});
    res.total += extra;
  }
  if(document.getElementById('risk_finish_gr23').checked){
    const extra = sums.finish * (T_MOYA.risks.gr23 || 0.0015);
    res.parts.push({name:'–ì—Ä.2+3 (–û—Ç–¥–µ–ª–∫–∞)', sum:sums.finish, rate:(T_MOYA.risks.gr23||0.0015), prem:extra});
    res.total += extra;
  }
  if(document.getElementById('risk_movable_gr1').checked){
    const extra = sums.movable * (T_MOYA.risks.gr1 || 0.002);
    res.parts.push({name:'–ì—Ä.1 (–î–ò)', sum:sums.movable, rate:(T_MOYA.risks.gr1||0.002), prem:extra});
    res.total += extra;
  }
  if(document.getElementById('risk_movable_gr23').checked){
    const extra = sums.movable * (T_MOYA.risks.gr23 || 0.0015);
    res.parts.push({name:'–ì—Ä.2+3 (–î–ò)', sum:sums.movable, rate:(T_MOYA.risks.gr23||0.0015), prem:extra});
    res.total += extra;
  }
  return res;
}

function calcExpress(sums){
  // find best matching express pack from EXPRESS_PACKS based on finish and movable
  if(!EXPRESS_PACKS) return null;

  // Find the best matching pack based on sums entered by user
  // Prioritize packs that best match the entered amounts
  let bestMatch = null;
  let bestScore = -1;

  EXPRESS_PACKS.forEach(pack => {
    let score = 0;
    const finishDiff = Math.abs(pack.finish - sums.finish);
    const movableDiff = Math.abs((pack.movable || 0) - sums.movable);

    // Better score for closer matches
    if (finishDiff <= 50000) score += 3;
    else if (finishDiff <= 100000) score += 2;
    else if (finishDiff <= 200000) score += 1;

    if (movableDiff <= 25000) score += 2;
    else if (movableDiff <= 50000) score += 1;

    // Prefer packs that are not too much larger than needed
    if (pack.finish <= sums.finish * 1.5) score += 1;
    if ((pack.movable || 0) <= sums.movable * 1.5) score += 1;

    if (score > bestScore) {
      bestScore = score;
      bestMatch = pack;
    }
  });

  // Fallback to the most expensive pack if no good match found
  if (!bestMatch) {
    bestMatch = EXPRESS_PACKS[EXPRESS_PACKS.length - 1];
  }

  const withGo = document.getElementById('insure_drone').checked;
  const price = withGo ? bestMatch.withGo : bestMatch.noGo;

  // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –¥–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—é –ø–∞–∫–µ—Ç–∞
  const parts = [];
  parts.push({name:'–í–∞—Ä–∏–∞–Ω—Ç ' + bestMatch.id, sum: null, rate: null, prem: null, isVariant: true});
  parts.push({name:'–û—Ç–¥–µ–ª–∫–∞ –∏ –∏–Ω–∂–µ–Ω–µ—Ä–Ω–æ–µ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ', sum: bestMatch.finish, rate: null, prem: null});
  if (bestMatch.movable && bestMatch.movable > 0) {
    parts.push({name:'–î–≤–∏–∂–∏–º–æ–µ –∏–º—É—â–µ—Å—Ç–≤–æ', sum: bestMatch.movable, rate: null, prem: null});
  } else {
    parts.push({name:'–î–≤–∏–∂–∏–º–æ–µ –∏–º—É—â–µ—Å—Ç–≤–æ', sum: 0, rate: null, prem: null});
  }
  if (withGo) {
    parts.push({name:'–ì—Ä–∞–∂–¥–∞–Ω—Å–∫–∞—è –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å', sum: 50000, rate: null, prem: null});
  }

  return {parts: parts, total: price, productName:'–≠–∫—Å–ø—Ä–µ—Å—Å –∫–≤–∞—Ä—Ç–∏—Ä–∞', variant: bestMatch.id};
}

function calcExpressGO(sums){
  if(!EXPRESS_GO_PACKS || sums.liability <= 0) return null;

  // –ù–∞–π—Ç–∏ –Ω–∞–∏–±–æ–ª–µ–µ –ø–æ–¥—Ö–æ–¥—è—â–∏–π –ø–∞–∫–µ—Ç –ø–æ —Å—É–º–º–µ –ì–û
  const pack = EXPRESS_GO_PACKS.find(p => p.sum >= sums.liability) || EXPRESS_GO_PACKS[EXPRESS_GO_PACKS.length - 1];

  return {
    product: '–≠–∫—Å–ø—Ä–µ—Å—Å –ì–û',
    total: pack.price,
    details: [
      `–°—Ç—Ä–∞—Ö–æ–≤–∞—è —Å—É–º–º–∞: ${fmt(pack.sum)} ‚ÇΩ`,
      `–ü—Ä–µ–º–∏—è: ${fmt(pack.price)} ‚ÇΩ`
    ]
  };
}

function calcPlatinum(sums){
  if(!PRODUCT5_TARIFFS) return null;

  // Find the best matching package based on user's sums
  let bestMatch = null;
  let bestFitScore = -1;

  PRODUCT5_TARIFFS.forEach(pack => {
    let fitScore = 0;
    if (sums.construct > 0 && pack.ke >= sums.construct) fitScore += 1;
    if (sums.finish > 0 && pack.oo >= sums.finish) fitScore += 2;
    if (sums.movable > 0 && pack.di >= sums.movable) fitScore += 1;
    if (sums.liability > 0 && pack.go >= sums.liability) fitScore += 1;

    if (fitScore > bestFitScore) {
      bestFitScore = fitScore;
      bestMatch = pack;
    }
  });

  if(!bestMatch) return null;

  const withDrone = document.getElementById('insure_drone').checked;
  const hasSpecial = bestMatch.special !== null && bestMatch.special !== undefined;
  const price = withDrone ? (bestMatch.special || bestMatch.standard) : bestMatch.standard;

  // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –¥–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—é –ø–∞–∫–µ—Ç–∞
  const parts = [];
  parts.push({name:'–í–∞—Ä–∏–∞–Ω—Ç ' + bestMatch.id, sum: null, rate: null, prem: null, isVariant: true});

  if (bestMatch.ke && bestMatch.ke > 0) {
    parts.push({name:'–ö–æ–Ω—Å—Ç—Ä—É–∫—Ç–∏–≤–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã', sum: bestMatch.ke, rate: null, prem: null});
  }
  if (bestMatch.oo && bestMatch.oo > 0) {
    parts.push({name:'–û—Ç–¥–µ–ª–∫–∞ –∏ –∏–Ω–∂–µ–Ω–µ—Ä–Ω–æ–µ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ', sum: bestMatch.oo, rate: null, prem: null});
  }
  if (bestMatch.di && bestMatch.di > 0) {
    parts.push({name:'–î–≤–∏–∂–∏–º–æ–µ –∏–º—É—â–µ—Å—Ç–≤–æ', sum: bestMatch.di, rate: null, prem: null});
  }
  if (bestMatch.go && bestMatch.go > 0) {
    parts.push({name:'–ì—Ä–∞–∂–¥–∞–Ω—Å–∫–∞—è –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å', sum: bestMatch.go, rate: null, prem: null});
  }

  if (hasSpecial) {
    parts.push({name:'–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞—è –ø—Ä–µ–º–∏—è', sum: null, rate: null, prem: bestMatch.standard, isStandard: true});
    parts.push({name:'–°–ø–µ—Ü–∏–∞–ª—å–Ω–∞—è –ø—Ä–µ–º–∏—è', sum: null, rate: null, prem: bestMatch.special, isSpecial: true});
  }

  return {
    parts: parts,
    total: price,
    productName:'–ü–ª–∞—Ç–∏–Ω—É–º –≠–∫—Å–ø—Ä–µ—Å—Å –ö–≤–∞—Ä—Ç–∏—Ä–∞',
    variant: bestMatch.id,
    hasSpecial: hasSpecial,
    standardPrice: bestMatch.standard,
    specialPrice: bestMatch.special
  };
}

function calcBastionFlat(sums){
  if(!T_BASTION) return null;
  // use T_BASTION.flat rates
  let total=0; const parts=[];
  if(sums.construct>0){
    const r = T_BASTION.flat.cons.rate;
    const prem = Math.max(sums.construct * r,0);
    parts.push({name:'–ö–æ–Ω—Å—Ç—Ä—É–∫—Ç–∏–≤ (–ë–∞—Å—Ç–∏–æ–Ω)', sum:sums.construct, rate:r, prem});
    total+=prem;
  }
  if(sums.finish>0){
    const r = T_BASTION.flat.finish.rate;
    const prem = sums.finish * r;
    parts.push({name:'–û—Ç–¥–µ–ª–∫–∞ (–ë–∞—Å—Ç–∏–æ–Ω)', sum:sums.finish, rate:r, prem});
    total+=prem;
  }
  return {parts,total,productName:'–ë–∞—Å—Ç–∏–æ–Ω (–≤–æ–µ–Ω–Ω—ã–π —Ä–∏—Å–∫)'};
}

function renderResultBlock(name, calc){
  const div = document.createElement('div'); div.className='product';
  const title = document.createElement('div'); title.innerHTML='<b>'+name+'</b>';
  div.appendChild(title);
  const ul = document.createElement('div');

  // Handle different formats
  if (calc.details) {
    // For Express GO
    calc.details.forEach(detail => {
      const line = document.createElement('div');
      line.textContent = detail;
      ul.appendChild(line);
    });
  } else if (calc.parts) {
    // For other products with parts
    calc.parts.forEach(p=>{
    const line = document.createElement('div');

    if (p.isVariant) {
      // –í–∞—Ä–∏–∞–Ω—Ç –ø–∞–∫–µ—Ç–∞
      line.className = 'variant-info';
      line.textContent = p.name;
    } else if (p.isStandard) {
      // –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞—è –ø—Ä–µ–º–∏—è
      line.textContent = p.name + ': ' + (p.prem ? p.prem.toFixed(2)+' ‚ÇΩ' : '‚Äî');
      line.style.color = '#6b7280';
    } else if (p.isSpecial) {
      // –°–ø–µ—Ü–∏–∞–ª—å–Ω–∞—è –ø—Ä–µ–º–∏—è
      line.textContent = p.name + ': ' + (p.prem ? p.prem.toFixed(2)+' ‚ÇΩ' : '‚Äî');
      line.style.color = '#059669';
      line.style.fontWeight = '600';
    } else if (p.prem !== null) {
      // –î–ª—è –ø—Ä–æ–¥—É–∫—Ç–æ–≤ —Å —Ä–∞—Å—á–µ—Ç–æ–º –ø–æ —á–∞—Å—Ç—è–º (–ú–æ—è –∫–≤–∞—Ä—Ç–∏—Ä–∞, –ë–∞—Å—Ç–∏–æ–Ω)
      line.textContent = p.name + ': ' + (p.prem ? p.prem.toFixed(2)+' ‚ÇΩ' : (p.rate ? (p.rate*100).toFixed(3)+'%' : '‚Äî'));
    } else {
      // –î–ª—è –ø–∞–∫–µ—Ç–Ω—ã—Ö –ø—Ä–æ–¥—É–∫—Ç–æ–≤ (–≠–∫—Å–ø—Ä–µ—Å—Å, –ü–ª–∞—Ç–∏–Ω—É–º) - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ç—Ä–∞—Ö–æ–≤—ã–µ —Å—É–º–º—ã
      line.textContent = p.name + ': ' + (p.sum ? p.sum.toLocaleString('ru-RU') + ' ‚ÇΩ' : '–Ω–µ –≤–∫–ª—é—á–µ–Ω–æ');
    }
      ul.appendChild(line);
    });
  }

  const tot = document.createElement('div'); tot.className='total'; tot.textContent='–ò—Ç–æ–≥–æ: '+(calc.total?calc.total.toFixed(2)+' ‚ÇΩ':'0 ‚ÇΩ');
  div.appendChild(ul); div.appendChild(tot);

  // –î–æ–±–∞–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ–º –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–∏ –¥–ª—è Platinum
  if (calc.hasSpecial && name.includes('–ü–ª–∞—Ç–∏–Ω—É–º') && calc.parts) {
    const specialDiv = document.createElement('div');
    specialDiv.className = 'special-offer';
    specialDiv.innerHTML = `
      <div class="special-offer-title">–£—Å–ª–æ–≤–∏—è —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ–≥–æ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è</div>
      <div>–ë–µ–∑—É—Å–ª–æ–≤–Ω–∞—è —Ñ—Ä–∞–Ω—à–∏–∑–∞ –ø–æ –∏–º—É—â–µ—Å—Ç–≤–µ–Ω–Ω—ã–º —Ä–∏—Å–∫–∞–º (–±–µ–∑ –ì–û) ‚Äî 10 000 —Ä—É–±. –ø—Ä–∏ –≤—ã–ø–ª–∞—Ç–µ</div>
    `;
    div.appendChild(specialDiv);
  }

  return div;
}

// update UI based on type selection
function updateUI() {
  const type = document.querySelector("input[name='type']:checked").value;
  materialBlock.style.display = type==='house'?'block':'none';
  consLabel.style.display = type==='flat'?'block':'none';
}

// main calc
document.getElementById('btnCalc').addEventListener('click', ()=>{
  const type = document.querySelector("input[name='type']:checked").value;
  const material = document.querySelector("input[name='material']:checked")?.value || 'stone';
  const sums = {
    construct: Number(document.getElementById('sum_cons').value) || 0,
    finish: Number(document.getElementById('sum_finish').value) || 0,
    movable: Number(document.getElementById('sum_movable').value) || 0,
    liability: Number(document.getElementById('sum_go').value) || 0
  };
  const results = document.getElementById('results'); results.innerHTML='';
if(type==='house'){
    const dom = calcDomBez(sums, material);
    if(dom) results.appendChild(renderResultBlock('–î–æ–º –±–µ–∑ –∑–∞–±–æ—Ç', dom));
    // Bastion for house too if insure drone checked
    if(document.getElementById('insure_drone').checked){
      const bast = (T_BASTION) ? (function(){
        // house bastion rates
        let parts=[]; let total=0;
        if(sums.construct>0){
          const r=T_BASTION.house.cons.rate; const p=sums.construct*r; parts.push({name:'–ö–æ–Ω—Å—Ç—Ä—É–∫—Ç–∏–≤ (–ë–∞—Å—Ç–∏–æ–Ω)',prem:p}); total+=p;
        }
        if(sums.finish>0){
          const r=T_BASTION.house.finish.rate; const p=sums.finish*r; parts.push({name:'–û—Ç–¥–µ–ª–∫–∞ (–ë–∞—Å—Ç–∏–æ–Ω)',prem:p}); total+=p;
        }
        return {parts,total};
      })() : null;
      if(bast) results.appendChild(renderResultBlock('–ë–∞—Å—Ç–∏–æ–Ω (–≤–æ–µ–Ω–Ω—ã–π —Ä–∏—Å–∫)', bast));
    }
  } else {
    // apartment: determine which products to show based on entered data
    const hasPropertyObjects = sums.construct > 0 || sums.finish > 0 || sums.movable > 0;
    const hasLiabilityOnly = sums.liability > 0 && !hasPropertyObjects;

    if (hasLiabilityOnly) {
      // Only liability - show Express GO
      const expressGO = calcExpressGO(sums);
      if(expressGO) results.appendChild(renderResultBlock(expressGO.product, expressGO));
    } else if (hasPropertyObjects) {
      // Property objects present - show relevant products
      const mMoya = calcMoya(sums);
      if(mMoya) results.appendChild(renderResultBlock('–ú–æ—è –∫–≤–∞—Ä—Ç–∏—Ä–∞', mMoya));

      const expr = calcExpress(sums);
      if(expr) results.appendChild(renderResultBlock(expr.productName||'–≠–∫—Å–ø—Ä–µ—Å—Å –∫–≤–∞—Ä—Ç–∏—Ä–∞', expr));

      const plat = calcPlatinum(sums);
      if(plat) results.appendChild(renderResultBlock(plat.productName||'–ü–ª–∞—Ç–∏–Ω—É–º –≠–∫—Å–ø—Ä–µ—Å—Å –ö–≤–∞—Ä—Ç–∏—Ä–∞', plat));

      // Show Bastion if drone coverage is selected
      if(document.getElementById('insure_drone')?.checked) {
        const bast = calcBastionFlat(sums);
        if(bast) results.appendChild(renderResultBlock(bast.productName||'–ë–∞—Å—Ç–∏–æ–Ω (–≤–æ–µ–Ω–Ω—ã–µ —Ä–∏—Å–∫–∏)', bast));
      }
    }
  }
});


// UI elements
const materialBlock=document.getElementById('materialBlock');
const consLabel=document.getElementById('sum_cons').closest('label');

// Update UI when type changes
document.querySelectorAll("input[name='type']").forEach(radio => {
  radio.addEventListener('change', updateUI);
});

// Auto recalc when drone checkbox changes
document.getElementById('insure_drone').addEventListener('change', () => {
  document.getElementById('btnCalc').click();
});

// Initialize UI
updateUI();
</script>
</body>
</html>
