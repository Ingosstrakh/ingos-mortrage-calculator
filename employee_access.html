<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Employee Access — Calculators</title>
  <style>
body{font-family:Arial,Helvetica,sans-serif;background:#f6f7fb;padding:20px}
.container{max-width:1000px;margin:0 auto}
.card{background:#fff;padding:12px;border-radius:8px;margin-bottom:12px}
label{display:block;margin:6px 0}
.results .product{border-bottom:1px solid #eee;padding:8px 0}
.total{font-weight:bold}
.small{color:#555;font-size:13px}
</style>
</head>
<body>
<div class="container">
  <h1>Employee access — расчёт</h1>
  <div class="card">
    <strong>Пароль доступа:</strong> (скрыто в продакшн) — тестовый доступ
  </div>

  <div class="card">
    <h3>Что страхуем?</h3>
    <label><input type="radio" name="type" value="house" checked> Жилой дом</label>
    <label><input type="radio" name="type" value="flat"> Квартира</label>
    <div id="materialBlock" class="small" style="margin-top:8px">
      Материал стен: 
      <label><input type="radio" name="material" value="stone" checked> Камень / кирпич</label>
      <label><input type="radio" name="material" value="wood"> Дерево</label>
    </div>
  </div>

  <div class="card">
    <h3>Ввод сумм по подобъектам</h3>
    <label>Конструктивные элементы: <input id="sum_cons" type="number" value="0"></label>
    <label>Отделка и инженерное оборудование: <input id="sum_finish" type="number" value="0"></label>
    <label>Движимое имущество: <input id="sum_movable" type="number" value="0"></label>
    <label>Гражданская ответственность: <input id="sum_go" type="number" value="0"></label>

    <div style="margin-top:8px">
      <label><input id="risk_finish_gr1" type="checkbox"> Группа рисков 1 (к Отделке)</label>
      <label><input id="risk_finish_gr23" type="checkbox"> Группа рисков 2+3 (к Отделке)</label>
      <label><input id="risk_movable_gr1" type="checkbox"> Группа рисков 1 (к ДИ)</label>
      <label><input id="risk_movable_gr23" type="checkbox"> Группа рисков 2+3 (к ДИ)</label>
    </div>

    <div style="margin-top:8px">
      <label><input id="insure_drone" type="checkbox"> Застраховать от БПЛА (Бастион)</label>
    </div>

    <div style="margin-top:12px">
      <button id="btnCalc">Рассчитать</button>
    </div>
  </div>

  <div class="card results">
    <h3>Результаты</h3>
    <div id="results"></div>
  </div>
</div>

<script type="module">
/*
  Robust loader for tariff modules. Attempts dynamic import; if named export missing,
  fetches file and extracts const literal for the requested name.
*/
async function loadNamed(path, name) {
  try {
    const m = await import(path);
    if (m && (m[name] !== undefined)) return m[name];
    // try default
    if (m && m.default !== undefined) return m.default;
  } catch(e){
    // console.warn('import failed', path, e);
  }
  // fallback: fetch file and extract const <name> = <literal>;
  const txt = await (await fetch(path)).text();
  // try export const NAME = ... first
  const re2 = new RegExp(`export\\s+const\\s+${name}\\s*=\\s*([\\s\\S]*?);\\n`);
  let m = txt.match(re2);
  if (!m) {
    // try const NAME = ...
    const re = new RegExp(`const\\s+${name}\\s*=\\s*([\\s\\S]*?);\\n`);
    m = txt.match(re);
  }
  if (!m) {
    console.warn('Could not extract', name, 'from', path);
    return undefined;
  }
  const literal = m[1];
  try {
    return eval('(' + literal + ')');
  } catch(e){
    console.error('Eval failed for', name, e);
    return undefined;
  }
}

// load all tariffs we may need
let T_DOMBEZ, T_MOYA, EXPRESS_PACKS, PRODUCT5_TARIFFS, T_BASTION, EXPRESS_GO_PACKS;
async function loadAll() {
  T_DOMBEZ = await loadNamed('./tariffs.dombez.js','TARIFFS');
  T_MOYA = await loadNamed('./tariffs.moyakvartira.js','T_MOYA');
  EXPRESS_PACKS = await loadNamed('./tariffs.express.js','EXPRESS_PACKS');
  PRODUCT5_TARIFFS = await loadNamed('./tariffs.platinum.express.js','PRODUCT5_TARIFFS');
  T_BASTION = await loadNamed('./tariffs.bastion.js','T_BASTION');
  EXPRESS_GO_PACKS = await loadNamed('./tariffs.express_go.js','EXPRESS_GO_PACKS');
  console.log('Tariffs loaded:', {T_DOMBEZ,T_MOYA,EXPRESS_PACKS,PRODUCT5_TARIFFS,T_BASTION,EXPRESS_GO_PACKS});
}
await loadAll();

// helper find rate in ranges
function findRateFromRanges(ranges, sum){
  if(!ranges) return 0;
  for(const r of ranges){
    if(sum >= (r.min||r.minSum||0) && sum <= (r.max||r.maxSum||Infinity)) return r.rate;
  }
  // fallback last
  if(ranges.length) return ranges[ranges.length-1].rate;
  return 0;
}

// calculate functions for products
function calcDomBez(sums, material){
  // T_DOMBEZ structure expected as in tariffs.dombez.js -> TARIFFS
  if(!T_DOMBEZ) return null;
  let res = {};
  // finish uses material
  const finishRates = T_DOMBEZ.finish && T_DOMBEZ.finish[material];
  let finishRate = findRateFromRanges(finishRates, sums.finish);
  if(sums.finish>0 && document.getElementById('risk_finish_gr1').checked) finishRate += (T_MOYA?.risks?.gr1 || 0.002);
  if(sums.finish>0 && document.getElementById('risk_finish_gr23').checked) finishRate += (T_MOYA?.risks?.gr23 || 0.0015);
  if(document.getElementById('hasStove') && finishRate) finishRate *= (T_DOMBEZ.stoveCoefficient || 1.15);
  const finishPrem = sums.finish * finishRate;
  // movable
  const movableRate = findRateFromRanges(T_DOMBEZ.movable || [], sums.movable);
  const movablePrem = sums.movable * movableRate;
  // liability
  const liRate = findRateFromRanges(T_DOMBEZ.liability || [], sums.liability);
  const liPrem = sums.liability * liRate;
  // constructive - not in dombez tariffs in our file; assume 0
  const consPrem = (T_DOMBEZ.constructive && findRateFromRanges(T_DOMBEZ.constructive[material]||[], sums.construct)) || 0;
  res.parts = [
    {name:'Отделка и ИО', sum:sums.finish, rate:finishRate, prem:finishPrem},
    {name:'Движимое имущество', sum:sums.movable, rate:movableRate, prem:movablePrem},
    {name:'Гражданская ответственность', sum:sums.liability, rate:liRate, prem:liPrem},
    {name:'Конструктивные элементы', sum:sums.construct, rate:0, prem:consPrem}
  ];
  res.total = res.parts.reduce((a,b)=>a + (b.prem||0),0);
  return res;
}

function calcMoya(sums){
  if(!T_MOYA) return null;
  let res = {parts:[], total:0};
  // constructive
  if(sums.construct>0){
    const rate = (sums.construct>0 && ( (sums.finish>0||sums.movable>0) ? T_MOYA.constructive.withOthers : T_MOYA.constructive.only ));
    const prem = sums.construct * rate;
    res.parts.push({name:'Конструктив', sum:sums.construct, rate, prem});
    res.total += prem;
  }
  // finish
  if(sums.finish>0){
    const rate = findRateFromRanges(T_MOYA.finish, sums.finish);
    const prem = sums.finish * rate;
    res.parts.push({name:'Отделка и ИО', sum:sums.finish, rate, prem});
    res.total += prem;
  }
  // movable
  if(sums.movable>0){
    const rate = findRateFromRanges(T_MOYA.movable, sums.movable);
    const prem = sums.movable * rate;
    res.parts.push({name:'Движимое имущество', sum:sums.movable, rate, prem});
    res.total += prem;
  }
  // go
  if(sums.liability>0){
    const rate = (T_MOYA.go.alone || 0.007);
    const prem = sums.liability * rate;
    res.parts.push({name:'ГО', sum:sums.liability, rate, prem});
    res.total += prem;
  }
  // risks groups applied
  if(document.getElementById('risk_finish_gr1').checked){
    const extra = sums.finish * (T_MOYA.risks.gr1 || 0.002);
    res.parts.push({name:'Гр.1 (Отделка)', sum:sums.finish, rate:(T_MOYA.risks.gr1||0.002), prem:extra});
    res.total += extra;
  }
  if(document.getElementById('risk_finish_gr23').checked){
    const extra = sums.finish * (T_MOYA.risks.gr23 || 0.0015);
    res.parts.push({name:'Гр.2+3 (Отделка)', sum:sums.finish, rate:(T_MOYA.risks.gr23||0.0015), prem:extra});
    res.total += extra;
  }
  if(document.getElementById('risk_movable_gr1').checked){
    const extra = sums.movable * (T_MOYA.risks.gr1 || 0.002);
    res.parts.push({name:'Гр.1 (ДИ)', sum:sums.movable, rate:(T_MOYA.risks.gr1||0.002), prem:extra});
    res.total += extra;
  }
  if(document.getElementById('risk_movable_gr23').checked){
    const extra = sums.movable * (T_MOYA.risks.gr23 || 0.0015);
    res.parts.push({name:'Гр.2+3 (ДИ)', sum:sums.movable, rate:(T_MOYA.risks.gr23||0.0015), prem:extra});
    res.total += extra;
  }
  return res;
}

function calcExpress(sums){
  // find best matching express pack from EXPRESS_PACKS based on finish and movable
  if(!EXPRESS_PACKS) return null;
  // find pack where finish >= pack.finish and movable >= pack.movable
  let matched = EXPRESS_PACKS.find(p => sums.finish >= p.finish && sums.movable >= (p.movable||0));
  if(!matched) {
    // find nearest where finish >=
    matched = EXPRESS_PACKS.slice().reverse().find(p => sums.finish >= p.finish) || EXPRESS_PACKS[0];
  }
  if(!matched) return null;
  const price = (document.getElementById('insure_drone').checked ? matched.withGo : matched.noGo);
  // for display break down heuristically
  return {parts:[
    {name:'Пакет Экспресс', sum: matched.finish, rate: null, prem: price}
  ], total: price, productName:'Экспресс квартира'};
}

function calcPlatinum(sums){
  if(!PRODUCT5_TARIFFS) return null;
  // PRODUCT5_TARIFFS array of packages with oo, di, go etc and standard price
  // choose first variant where sums meet at least oo and di thresholds
  let matched = PRODUCT5_TARIFFS.find(p => {
    const okOo = (sums.finish>= (p.oo||0));
    const okDi = (sums.movable>= (p.di||0));
    const okGo = (sums.liability>= (p.go||0));
    return okOo && okDi && okGo;
  });
  if(!matched){
    // fallback choose nearest by oo
    matched = PRODUCT5_TARIFFS.slice().reverse().find(p => sums.finish >= (p.oo||0)) || PRODUCT5_TARIFFS[0];
  }
  const price = document.getElementById('insure_drone').checked ? (matched.special || matched.standard) : matched.standard;
  return {parts:[
    {name:'Платинум пакет', sum: null, rate:null, prem: price}
  ], total: price, productName:'Платинум Экспресс Квартира'};
}

function calcBastionFlat(sums){
  if(!T_BASTION) return null;
  // use T_BASTION.flat rates
  let total=0; const parts=[];
  if(sums.construct>0){
    const r = T_BASTION.flat.cons.rate;
    const prem = Math.max(sums.construct * r,0);
    parts.push({name:'Конструктив (Бастион)', sum:sums.construct, rate:r, prem});
    total+=prem;
  }
  if(sums.finish>0){
    const r = T_BASTION.flat.finish.rate;
    const prem = sums.finish * r;
    parts.push({name:'Отделка (Бастион)', sum:sums.finish, rate:r, prem});
    total+=prem;
  }
  return {parts,total,productName:'Бастион (военный риск)'};
}

function renderResultBlock(name, calc){
  const div = document.createElement('div'); div.className='product';
  const title = document.createElement('div'); title.innerHTML='<b>'+name+'</b>';
  div.appendChild(title);
  const ul = document.createElement('div');
  calc.parts.forEach(p=>{
    const line = document.createElement('div');
    line.textContent = p.name + ': ' + (p.prem? p.prem.toFixed(2)+' ₽' : (p.rate? (p.rate*100).toFixed(3)+'%':'—') );
    ul.appendChild(line);
  });
  const tot = document.createElement('div'); tot.className='total'; tot.textContent='Итого: '+(calc.total?calc.total.toFixed(2)+' ₽':'0 ₽');
  div.appendChild(ul); div.appendChild(tot);
  return div;
}

// update UI based on type selection
function updateUI() {
  const type = document.querySelector("input[name='type']:checked").value;
  materialBlock.style.display = type==='house'?'block':'none';
  consLabel.style.display = type==='flat'?'block':'none';
}

// main calc
document.getElementById('btnCalc').addEventListener('click', ()=>{
  const type = document.querySelector("input[name='type']:checked").value;
  const material = document.querySelector("input[name='material']:checked")?.value || 'stone';
  const sums = {
    construct: Number(document.getElementById('sum_cons').value) || 0,
    finish: Number(document.getElementById('sum_finish').value) || 0,
    movable: Number(document.getElementById('sum_movable').value) || 0,
    liability: Number(document.getElementById('sum_go').value) || 0
  };
  const results = document.getElementById('results'); results.innerHTML='';
if(type==='house'){
    const dom = calcDomBez(sums, material);
    if(dom) results.appendChild(renderResultBlock('Дом без забот', dom));
    // Bastion for house too if insure drone checked
    if(document.getElementById('insure_drone').checked){
      const bast = (T_BASTION) ? (function(){
        // house bastion rates
        let parts=[]; let total=0;
        if(sums.construct>0){
          const r=T_BASTION.house.cons.rate; const p=sums.construct*r; parts.push({name:'Конструктив (Бастион)',prem:p}); total+=p;
        }
        if(sums.finish>0){
          const r=T_BASTION.house.finish.rate; const p=sums.finish*r; parts.push({name:'Отделка (Бастион)',prem:p}); total+=p;
        }
        return {parts,total};
      })() : null;
      if(bast) results.appendChild(renderResultBlock('Бастион (военный риск)', bast));
    }
  } else {
    // apartment: show multiple products
    const mMoya = calcMoya(sums);
    if(mMoya) results.appendChild(renderResultBlock('Моя квартира', mMoya));
    const expr = calcExpress(sums);
    if(expr) results.appendChild(renderResultBlock(expr.productName||'Экспресс квартира', expr));
    const plat = calcPlatinum(sums);
    if(plat) results.appendChild(renderResultBlock(plat.productName||'Платинум', plat));
    if(!document.getElementById('insure_drone')?.checked) return;
const bast = calcBastionFlat(sums);
    if(bast) results.appendChild(renderResultBlock(bast.productName||'Бастион', bast));
  }
});


// UI elements
const materialBlock=document.getElementById('materialBlock');
const consLabel=document.getElementById('sum_cons').closest('label');

// Update UI when type changes
document.querySelectorAll("input[name='type']").forEach(radio => {
  radio.addEventListener('change', updateUI);
});

// Auto recalc when drone checkbox changes
document.getElementById('insure_drone').addEventListener('change', () => {
  document.getElementById('btnCalc').click();
});

// Initialize UI
updateUI();
</script>
</body>
</html>
