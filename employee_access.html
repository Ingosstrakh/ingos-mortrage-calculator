<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>–°–æ—Ç—Ä—É–¥–Ω–∏–∫ –°–ö –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å.</title>
  <link rel="stylesheet" href="style.css">
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700;900&family=Playfair+Display:wght@400;700&display=swap" rel="stylesheet">
  <style>
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.7; }
    }
  </style>
</head>
<body>
  <!-- –ì–µ—Ä–æ–π—Å–∫–∞—è —Å–µ–∫—Ü–∏—è -->
  <header class="hero-section">
    <div class="hero-overlay"></div>
    <div class="hero-content">
      <div class="hero-logo">
        <div class="logo-icon">üèõÔ∏è</div>
        <h1 class="hero-title">–ò–ù–ì–û–°–°–¢–†–ê–•</h1>
        <div class="hero-subtitle">–°—Ä–∞–≤–Ω–µ–Ω–∏–µ –ø—Ä–æ–¥—É–∫—Ç–æ–≤ –ò–§–õ</div>
      </div>
    </div>
    <div class="hero-decoration">
      <div class="decoration-element"></div>
      <div class="decoration-element"></div>
      <div class="decoration-element"></div>
    </div>
  </header>

  <!-- –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç -->
  <main class="main-content">
    <div class="container">
      <a href="index.html" class="back-button">
        <span>‚Üê</span> <span>–ù–∞–∑–∞–¥ –∫ –≤—ã–±–æ—Ä—É –ø—Ä–æ–¥—É–∫—Ç–æ–≤</span>
      </a>
      <div class="header"><h1 style="margin:0">–ú—É–ª—å—Ç–∏–≤–∞—Ä–∏–∞—Ç–∏–≤–Ω—ã–π –ø—Ä–æ–¥—É–∫—Ç –°–ö</h1></div>
  <div class="card">
    <strong>–≤—ã–±–µ—Ä–∏ –∏ –ø–æ–ª—É—á–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç</strong>
  </div>

  <div class="card">
    <h3>–ß—Ç–æ —Å—Ç—Ä–∞—Ö—É–µ–º?</h3>
    <label><input type="radio" name="type" value="house" checked> –ñ–∏–ª–æ–π –¥–æ–º</label>
    <label><input type="radio" name="type" value="flat"> –ö–≤–∞—Ä—Ç–∏—Ä–∞</label>
    <div id="materialBlock" class="small" style="margin-top:8px">
      –ú–∞—Ç–µ—Ä–∏–∞–ª —Å—Ç–µ–Ω: 
      <label><input type="radio" name="material" value="stone" checked> –ö–∞–º–µ–Ω—å / –∫–∏—Ä–ø–∏—á</label>
      <label><input type="radio" name="material" value="wood"> –î–µ—Ä–µ–≤–æ</label>
    </div>
  </div>

  <div class="card">
    <h3>–í–≤–æ–¥ —Å—É–º–º –ø–æ –ø–æ–¥–æ–±—ä–µ–∫—Ç–∞–º</h3>
    <label>–ö–æ–Ω—Å—Ç—Ä—É–∫—Ç–∏–≤–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã: <input id="sum_cons" type="number" value="0"></label>
    <label>–û—Ç–¥–µ–ª–∫–∞ –∏ –∏–Ω–∂–µ–Ω–µ—Ä–Ω–æ–µ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ: <input id="sum_finish" type="number" value="0"></label>
    <label>–î–≤–∏–∂–∏–º–æ–µ –∏–º—É—â–µ—Å—Ç–≤–æ: <input id="sum_movable" type="number" value="0"></label>
    <label>–ì—Ä–∞–∂–¥–∞–Ω—Å–∫–∞—è –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å: <input id="sum_go" type="number" value="0"></label>

    <div style="margin-top:8px">
      <label><input id="risk_finish_gr1" type="checkbox"> –ì—Ä—É–ø–ø–∞ —Ä–∏—Å–∫–æ–≤ 1 (–∫ –û—Ç–¥–µ–ª–∫–µ)</label>
      <label><input id="risk_finish_gr23" type="checkbox"> –ì—Ä—É–ø–ø–∞ —Ä–∏—Å–∫–æ–≤ 2+3 (–∫ –û—Ç–¥–µ–ª–∫–µ)</label>
      <label><input id="risk_movable_gr1" type="checkbox"> –ì—Ä—É–ø–ø–∞ —Ä–∏—Å–∫–æ–≤ 1 (–∫ –î–ò)</label>
      <label><input id="risk_movable_gr23" type="checkbox"> –ì—Ä—É–ø–ø–∞ —Ä–∏—Å–∫–æ–≤ 2+3 (–∫ –î–ò)</label>
    </div>

    <div style="margin-top:8px">
      <label><input id="insure_drone" type="checkbox"> –ó–∞—Å—Ç—Ä–∞—Ö–æ–≤–∞—Ç—å –æ—Ç –ë–ü–õ–ê (–ë–∞—Å—Ç–∏–æ–Ω)</label>
    </div>

    <div style="margin-top:12px">
      <button id="btnCalc">–†–∞—Å—Å—á–∏—Ç–∞—Ç—å</button>
    </div>
  </div>

  <div class="card results">
    <h3>–†–µ–∑—É–ª—å—Ç–∞—Ç—ã</h3>
    <div id="results"></div>
      </div>
    </div>
  </main>

  <script type="module">
/*
  Robust loader for tariff modules. Attempts dynamic import; if named export missing,
  fetches file and extracts const literal for the requested name.
*/
async function loadNamed(path, name) {
  try {
    const m = await import(path);
    if (m && (m[name] !== undefined)) return m[name];
    // try default
    if (m && m.default !== undefined) return m.default;
  } catch(e){
    // console.warn('import failed', path, e);
  }
  // fallback: fetch file and extract const <name> = <literal>;
  const txt = await (await fetch(path)).text();
  // try export const NAME = ... first
  const re2 = new RegExp(`export\\s+const\\s+${name}\\s*=\\s*([\\s\\S]*?);\\n`);
  let m = txt.match(re2);
  if (!m) {
    // try const NAME = ...
    const re = new RegExp(`const\\s+${name}\\s*=\\s*([\\s\\S]*?);\\n`);
    m = txt.match(re);
  }
  if (!m) {
    console.warn('Could not extract', name, 'from', path);
    return undefined;
  }
  const literal = m[1];
  try {
    return eval('(' + literal + ')');
  } catch(e){
    console.error('Eval failed for', name, e);
    return undefined;
  }
}

// load all tariffs we may need
let T_DOMBEZ, T_MOYA, EXPRESS_PACKS, PRODUCT5_TARIFFS, T_BASTION, EXPRESS_GO_PACKS;
async function loadAll() {
  T_DOMBEZ = await loadNamed('./tariffs.dombez.js','TARIFFS');
  T_MOYA = await loadNamed('./tariffs.moyakvartira.js','T_MOYA');
  EXPRESS_PACKS = await loadNamed('./tariffs.express.js','EXPRESS_PACKS');
  PRODUCT5_TARIFFS = await loadNamed('./tariffs.platinum.express.js','PRODUCT5_TARIFFS');
  T_BASTION = await loadNamed('./tariffs.bastion.js','T_BASTION');
  EXPRESS_GO_PACKS = await loadNamed('./tariffs.express_go.js','EXPRESS_GO_PACKS');
  console.log('Tariffs loaded:', {T_DOMBEZ,T_MOYA,EXPRESS_PACKS,PRODUCT5_TARIFFS,T_BASTION,EXPRESS_GO_PACKS});
}
await loadAll();

// helper find rate in ranges
function findRateFromRanges(ranges, sum){
  if(!ranges) return 0;
  for(const r of ranges){
    if(sum >= (r.min||r.minSum||0) && sum <= (r.max||r.maxSum||Infinity)) return r.rate;
  }
  // fallback last
  if(ranges.length) return ranges[ranges.length-1].rate;
  return 0;
}

// calculate functions for products
function calcDomBez(sums, material){
  // T_DOMBEZ structure expected as in tariffs.dombez.js -> TARIFFS
  if(!T_DOMBEZ) return null;
  let res = {};
  // finish uses material
  const finishRates = T_DOMBEZ.finish && T_DOMBEZ.finish[material];
  let finishRate = findRateFromRanges(finishRates, sums.finish);
  if(sums.finish>0 && document.getElementById('risk_finish_gr1').checked) finishRate += (T_MOYA?.risks?.gr1 || 0.002);
  if(sums.finish>0 && document.getElementById('risk_finish_gr23').checked) finishRate += (T_MOYA?.risks?.gr23 || 0.0015);
  if(document.getElementById('hasStove') && finishRate) finishRate *= (T_DOMBEZ.stoveCoefficient || 1.15);
  const finishPrem = sums.finish * finishRate;
  // movable
  const movableRate = findRateFromRanges(T_DOMBEZ.movable || [], sums.movable);
  const movablePrem = sums.movable * movableRate;
  // liability
  const liRate = findRateFromRanges(T_DOMBEZ.liability || [], sums.liability);
  const liPrem = sums.liability * liRate;
  // constructive - not in dombez tariffs in our file; assume 0
  const consPrem = (T_DOMBEZ.constructive && findRateFromRanges(T_DOMBEZ.constructive[material]||[], sums.construct)) || 0;
  res.parts = [
    {name:'–û—Ç–¥–µ–ª–∫–∞ –∏ –ò–û', sum:sums.finish, rate:finishRate, prem:finishPrem},
    {name:'–î–≤–∏–∂–∏–º–æ–µ –∏–º—É—â–µ—Å—Ç–≤–æ', sum:sums.movable, rate:movableRate, prem:movablePrem},
    {name:'–ì—Ä–∞–∂–¥–∞–Ω—Å–∫–∞—è –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å', sum:sums.liability, rate:liRate, prem:liPrem},
    {name:'–ö–æ–Ω—Å—Ç—Ä—É–∫—Ç–∏–≤–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã', sum:sums.construct, rate:0, prem:consPrem}
  ];
  res.total = res.parts.reduce((a,b)=>a + (b.prem||0),0);
  return res;
}

function calcMoya(sums){
  if(!T_MOYA) return null;
  let res = {parts:[], total:0};
  // constructive
  if(sums.construct>0){
    const rate = (sums.construct>0 && ( (sums.finish>0||sums.movable>0) ? T_MOYA.constructive.withOthers : T_MOYA.constructive.only ));
    const prem = sums.construct * rate;
    res.parts.push({name:'–ö–æ–Ω—Å—Ç—Ä—É–∫—Ç–∏–≤', sum:sums.construct, rate, prem});
    res.total += prem;
  }
  // finish
  if(sums.finish>0){
    const rate = findRateFromRanges(T_MOYA.finish, sums.finish);
    const prem = sums.finish * rate;
    res.parts.push({name:'–û—Ç–¥–µ–ª–∫–∞ –∏ –ò–û', sum:sums.finish, rate, prem});
    res.total += prem;
  }
  // movable
  if(sums.movable>0){
    const rate = findRateFromRanges(T_MOYA.movable, sums.movable);
    const prem = sums.movable * rate;
    res.parts.push({name:'–î–≤–∏–∂–∏–º–æ–µ –∏–º—É—â–µ—Å—Ç–≤–æ', sum:sums.movable, rate, prem});
    res.total += prem;
  }
  // go
  if(sums.liability>0){
    const rate = (T_MOYA.go.alone || 0.007);
    const prem = sums.liability * rate;
    res.parts.push({name:'–ì–û', sum:sums.liability, rate, prem});
    res.total += prem;
  }
  // risks groups applied
  if(document.getElementById('risk_finish_gr1').checked){
    const extra = sums.finish * (T_MOYA.risks.gr1 || 0.002);
    res.parts.push({name:'–ì—Ä.1 (–û—Ç–¥–µ–ª–∫–∞)', sum:sums.finish, rate:(T_MOYA.risks.gr1||0.002), prem:extra});
    res.total += extra;
  }
  if(document.getElementById('risk_finish_gr23').checked){
    const extra = sums.finish * (T_MOYA.risks.gr23 || 0.0015);
    res.parts.push({name:'–ì—Ä.2+3 (–û—Ç–¥–µ–ª–∫–∞)', sum:sums.finish, rate:(T_MOYA.risks.gr23||0.0015), prem:extra});
    res.total += extra;
  }
  if(document.getElementById('risk_movable_gr1').checked){
    const extra = sums.movable * (T_MOYA.risks.gr1 || 0.002);
    res.parts.push({name:'–ì—Ä.1 (–î–ò)', sum:sums.movable, rate:(T_MOYA.risks.gr1||0.002), prem:extra});
    res.total += extra;
  }
  if(document.getElementById('risk_movable_gr23').checked){
    const extra = sums.movable * (T_MOYA.risks.gr23 || 0.0015);
    res.parts.push({name:'–ì—Ä.2+3 (–î–ò)', sum:sums.movable, rate:(T_MOYA.risks.gr23||0.0015), prem:extra});
    res.total += extra;
  }
  return res;
}

function calcExpress(sums){
  // find best matching express pack from EXPRESS_PACKS based on finish and movable
  if(!EXPRESS_PACKS) return null;
  // find pack where finish >= pack.finish and movable >= pack.movable
  let matched = EXPRESS_PACKS.find(p => sums.finish >= p.finish && sums.movable >= (p.movable||0));
  if(!matched) {
    // find nearest where finish >=
    matched = EXPRESS_PACKS.slice().reverse().find(p => sums.finish >= p.finish) || EXPRESS_PACKS[0];
  }
  if(!matched) return null;
  const withGo = document.getElementById('insure_drone').checked;
  const price = withGo ? matched.withGo : matched.noGo;

  // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –¥–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—é –ø–∞–∫–µ—Ç–∞
  const parts = [];
  parts.push({name:'–û—Ç–¥–µ–ª–∫–∞ –∏ –∏–Ω–∂–µ–Ω–µ—Ä–Ω–æ–µ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ', sum: matched.finish, rate: null, prem: null});
  if (matched.movable && matched.movable > 0) {
    parts.push({name:'–î–≤–∏–∂–∏–º–æ–µ –∏–º—É—â–µ—Å—Ç–≤–æ', sum: matched.movable, rate: null, prem: null});
  } else {
    parts.push({name:'–î–≤–∏–∂–∏–º–æ–µ –∏–º—É—â–µ—Å—Ç–≤–æ', sum: 0, rate: null, prem: null});
  }
  if (withGo) {
    parts.push({name:'–ì—Ä–∞–∂–¥–∞–Ω—Å–∫–∞—è –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å', sum: 50000, rate: null, prem: null});
  }

  return {parts: parts, total: price, productName:'–≠–∫—Å–ø—Ä–µ—Å—Å –∫–≤–∞—Ä—Ç–∏—Ä–∞'};
}

function calcPlatinum(sums){
  if(!PRODUCT5_TARIFFS) return null;
  // PRODUCT5_TARIFFS array of packages with oo, di, go etc and standard price
  // choose first variant where sums meet at least oo and di thresholds
  let matched = PRODUCT5_TARIFFS.find(p => {
    const okOo = (sums.finish>= (p.oo||0));
    const okDi = (sums.movable>= (p.di||0));
    const okGo = (sums.liability>= (p.go||0));
    return okOo && okDi && okGo;
  });
  if(!matched){
    // fallback choose nearest by oo
    matched = PRODUCT5_TARIFFS.slice().reverse().find(p => sums.finish >= (p.oo||0)) || PRODUCT5_TARIFFS[0];
  }
  const withDrone = document.getElementById('insure_drone').checked;
  const price = withDrone ? (matched.special || matched.standard) : matched.standard;

  // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –¥–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—é –ø–∞–∫–µ—Ç–∞
  const parts = [];
  if (matched.ke && matched.ke > 0) {
    parts.push({name:'–ö–æ–Ω—Å—Ç—Ä—É–∫—Ç–∏–≤–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã', sum: matched.ke, rate: null, prem: null});
  }
  if (matched.oo && matched.oo > 0) {
    parts.push({name:'–û—Ç–¥–µ–ª–∫–∞ –∏ –∏–Ω–∂–µ–Ω–µ—Ä–Ω–æ–µ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ', sum: matched.oo, rate: null, prem: null});
  }
  if (matched.di && matched.di > 0) {
    parts.push({name:'–î–≤–∏–∂–∏–º–æ–µ –∏–º—É—â–µ—Å—Ç–≤–æ', sum: matched.di, rate: null, prem: null});
  }
  if (matched.go && matched.go > 0) {
    parts.push({name:'–ì—Ä–∞–∂–¥–∞–Ω—Å–∫–∞—è –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å', sum: matched.go, rate: null, prem: null});
  }

  return {parts: parts, total: price, productName:'–ü–ª–∞—Ç–∏–Ω—É–º –≠–∫—Å–ø—Ä–µ—Å—Å –ö–≤–∞—Ä—Ç–∏—Ä–∞'};
}

function calcBastionFlat(sums){
  if(!T_BASTION) return null;
  // use T_BASTION.flat rates
  let total=0; const parts=[];
  if(sums.construct>0){
    const r = T_BASTION.flat.cons.rate;
    const prem = Math.max(sums.construct * r,0);
    parts.push({name:'–ö–æ–Ω—Å—Ç—Ä—É–∫—Ç–∏–≤ (–ë–∞—Å—Ç–∏–æ–Ω)', sum:sums.construct, rate:r, prem});
    total+=prem;
  }
  if(sums.finish>0){
    const r = T_BASTION.flat.finish.rate;
    const prem = sums.finish * r;
    parts.push({name:'–û—Ç–¥–µ–ª–∫–∞ (–ë–∞—Å—Ç–∏–æ–Ω)', sum:sums.finish, rate:r, prem});
    total+=prem;
  }
  return {parts,total,productName:'–ë–∞—Å—Ç–∏–æ–Ω (–≤–æ–µ–Ω–Ω—ã–π —Ä–∏—Å–∫)'};
}

function renderResultBlock(name, calc){
  const div = document.createElement('div'); div.className='product';
  const title = document.createElement('div'); title.innerHTML='<b>'+name+'</b>';
  div.appendChild(title);
  const ul = document.createElement('div');
  calc.parts.forEach(p=>{
    const line = document.createElement('div');
    if (p.prem !== null) {
      // –î–ª—è –ø—Ä–æ–¥—É–∫—Ç–æ–≤ —Å —Ä–∞—Å—á–µ—Ç–æ–º –ø–æ —á–∞—Å—Ç—è–º (–ú–æ—è –∫–≤–∞—Ä—Ç–∏—Ä–∞, –ë–∞—Å—Ç–∏–æ–Ω)
      line.textContent = p.name + ': ' + (p.prem ? p.prem.toFixed(2)+' ‚ÇΩ' : (p.rate ? (p.rate*100).toFixed(3)+'%' : '‚Äî'));
    } else {
      // –î–ª—è –ø–∞–∫–µ—Ç–Ω—ã—Ö –ø—Ä–æ–¥—É–∫—Ç–æ–≤ (–≠–∫—Å–ø—Ä–µ—Å—Å, –ü–ª–∞—Ç–∏–Ω—É–º) - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ç—Ä–∞—Ö–æ–≤—ã–µ —Å—É–º–º—ã
      line.textContent = p.name + ': ' + (p.sum ? p.sum.toLocaleString('ru-RU') + ' ‚ÇΩ' : '–Ω–µ –≤–∫–ª—é—á–µ–Ω–æ');
    }
    ul.appendChild(line);
  });
  const tot = document.createElement('div'); tot.className='total'; tot.textContent='–ò—Ç–æ–≥–æ: '+(calc.total?calc.total.toFixed(2)+' ‚ÇΩ':'0 ‚ÇΩ');
  div.appendChild(ul); div.appendChild(tot);
  return div;
}

// update UI based on type selection
function updateUI() {
  const type = document.querySelector("input[name='type']:checked").value;
  materialBlock.style.display = type==='house'?'block':'none';
  consLabel.style.display = type==='flat'?'block':'none';
}

// main calc
document.getElementById('btnCalc').addEventListener('click', ()=>{
  const type = document.querySelector("input[name='type']:checked").value;
  const material = document.querySelector("input[name='material']:checked")?.value || 'stone';
  const sums = {
    construct: Number(document.getElementById('sum_cons').value) || 0,
    finish: Number(document.getElementById('sum_finish').value) || 0,
    movable: Number(document.getElementById('sum_movable').value) || 0,
    liability: Number(document.getElementById('sum_go').value) || 0
  };
  const results = document.getElementById('results'); results.innerHTML='';
if(type==='house'){
    const dom = calcDomBez(sums, material);
    if(dom) results.appendChild(renderResultBlock('–î–æ–º –±–µ–∑ –∑–∞–±–æ—Ç', dom));
    // Bastion for house too if insure drone checked
    if(document.getElementById('insure_drone').checked){
      const bast = (T_BASTION) ? (function(){
        // house bastion rates
        let parts=[]; let total=0;
        if(sums.construct>0){
          const r=T_BASTION.house.cons.rate; const p=sums.construct*r; parts.push({name:'–ö–æ–Ω—Å—Ç—Ä—É–∫—Ç–∏–≤ (–ë–∞—Å—Ç–∏–æ–Ω)',prem:p}); total+=p;
        }
        if(sums.finish>0){
          const r=T_BASTION.house.finish.rate; const p=sums.finish*r; parts.push({name:'–û—Ç–¥–µ–ª–∫–∞ (–ë–∞—Å—Ç–∏–æ–Ω)',prem:p}); total+=p;
        }
        return {parts,total};
      })() : null;
      if(bast) results.appendChild(renderResultBlock('–ë–∞—Å—Ç–∏–æ–Ω (–≤–æ–µ–Ω–Ω—ã–π —Ä–∏—Å–∫)', bast));
    }
  } else {
    // apartment: show multiple products
    const mMoya = calcMoya(sums);
    if(mMoya) results.appendChild(renderResultBlock('–ú–æ—è –∫–≤–∞—Ä—Ç–∏—Ä–∞', mMoya));
    const expr = calcExpress(sums);
    if(expr) results.appendChild(renderResultBlock(expr.productName||'–≠–∫—Å–ø—Ä–µ—Å—Å –∫–≤–∞—Ä—Ç–∏—Ä–∞', expr));
    const plat = calcPlatinum(sums);
    if(plat) results.appendChild(renderResultBlock(plat.productName||'–ü–ª–∞—Ç–∏–Ω—É–º', plat));
    if(!document.getElementById('insure_drone')?.checked) return;
const bast = calcBastionFlat(sums);
    if(bast) results.appendChild(renderResultBlock(bast.productName||'–ë–∞—Å—Ç–∏–æ–Ω', bast));
  }
});


// UI elements
const materialBlock=document.getElementById('materialBlock');
const consLabel=document.getElementById('sum_cons').closest('label');

// Update UI when type changes
document.querySelectorAll("input[name='type']").forEach(radio => {
  radio.addEventListener('change', updateUI);
});

// Auto recalc when drone checkbox changes
document.getElementById('insure_drone').addEventListener('change', () => {
  document.getElementById('btnCalc').click();
});

// Initialize UI
updateUI();
</script>
</body>
</html>
